@inherits A2UIComponentBase
@using A2UI.Core.Processing
@using A2UI.Core.Messages
@using System.Text.Json
@inject DataBindingResolver BindingResolver
@inject EventDispatcher EventDispatcher

<button class="@GetCssClass()" style="@GetInlineStyle()" @onclick="HandleClick">
    @if (!string.IsNullOrEmpty(ChildComponentId))
    {
        <A2UIRenderer SurfaceId="@SurfaceId" ComponentId="@ChildComponentId" DataContextPath="@Component.DataContextPath" />
    }
</button>

@code {
    private string? ChildComponentId;
    private Dictionary<string, object>? ActionData;
    private bool IsPrimary;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        ChildComponentId = GetStringProperty("child");
        ActionData = GetDictionaryProperty("action");
        IsPrimary = GetBoolProperty("primary", false);
    }

    private void HandleClick()
    {
        if (ActionData == null)
        {
            return;
        }

        // Extract action name
        if (!ActionData.TryGetValue("name", out var nameObj) || nameObj is not string actionName)
        {
            Console.WriteLine($"[A2UIButton] Error: No action name found in component {Component.Id}");
            return;
        }

        // Resolve context
        var context = ResolveActionContext();

        // Create and dispatch user action
        var userAction = EventDispatcher.CreateUserAction(
            actionName,
            SurfaceId,
            Component.Id,
            context
        );

        EventDispatcher.DispatchUserAction(userAction);
    }

    /// <summary>
    /// Resolves the action context from ActionData.
    /// </summary>
    private Dictionary<string, object> ResolveActionContext()
    {
        if (!ActionData!.TryGetValue("context", out var contextObj))
        {
            return new Dictionary<string, object>();
        }

        var contextEntries = ParseContextEntries(contextObj);
        
        if (contextEntries != null && contextEntries.Count > 0)
        {
            return BindingResolver.ResolveActionContext(contextEntries, SurfaceId, Component.DataContextPath);
        }

        return new Dictionary<string, object>();
    }

    /// <summary>
    /// Parses context object into a list of entries, handling various JSON deserialization formats.
    /// </summary>
    private List<Dictionary<string, object>>? ParseContextEntries(object contextObj)
    {
        // Handle JsonElement (from JSON deserialization)
        if (contextObj is JsonElement jsonElement)
        {
            if (jsonElement.ValueKind == JsonValueKind.Array)
            {
                try
                {
                    return JsonSerializer.Deserialize<List<Dictionary<string, object>>>(jsonElement.GetRawText());
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[A2UIButton] Error deserializing JsonElement context: {ex.Message}");
                }
            }
        }
        // Handle List<object> (common case from JSON deserialization)
        else if (contextObj is System.Collections.IList list)
        {
            return ParseListContext(list);
        }
        // Handle direct List<Dictionary> (unlikely but possible)
        else if (contextObj is List<Dictionary<string, object>> directList)
        {
            return directList;
        }

        return null;
    }

    /// <summary>
    /// Parses IList context, converting JsonElement values to proper CLR types.
    /// </summary>
    private List<Dictionary<string, object>>? ParseListContext(System.Collections.IList list)
    {
        try
        {
            var json = JsonSerializer.Serialize(list);
            using var doc = JsonDocument.Parse(json);
            var array = doc.RootElement;

            var result = new List<Dictionary<string, object>>();

            foreach (var item in array.EnumerateArray())
            {
                var entry = new Dictionary<string, object>();

                foreach (var prop in item.EnumerateObject())
                {
                    // Convert JsonElement to appropriate CLR type
                    object value = prop.Value.ValueKind switch
                    {
                        JsonValueKind.String => prop.Value.GetString()!,
                        JsonValueKind.Number => prop.Value.GetDouble(),
                        JsonValueKind.True => true,
                        JsonValueKind.False => false,
                        JsonValueKind.Object => prop.Value.Clone(), // Keep as JsonElement for nested objects
                        JsonValueKind.Array => prop.Value.Clone(), // Keep as JsonElement for arrays
                        _ => prop.Value.Clone()
                    };

                    entry[prop.Name] = value;
                }

                result.Add(entry);
            }

            return result;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[A2UIButton] Error converting IList context: {ex.Message}");
            return null;
        }
    }

    protected override string GetCssClass()
    {
        var baseClass = Theme.Components.Button;
        var variantClass = IsPrimary ? Theme.Components.ButtonPrimary : Theme.Components.ButtonSecondary;
        return $"{baseClass} {variantClass}".Trim();
    }
}

